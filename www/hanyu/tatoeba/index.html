<html><head><title>Hanyu hear me</title>
<script src="../../lz-string.min.js"></script>
<script src="entries-lz.js" charset="utf-8"></script>
<script src="../trispeak.js"></script>
<script>
var subId = 't';
var entryId;
var zText;
var pyText;
var eText;
function speakQ() {
    speechSynthesis.cancel();
    espeak("The Chinese is:");
    zspeak(zText);
}
function colorPinyin(p) {
    var ret = '';
    var accumSyllable = '';
    var colorMap = {
        '1': '#faa', '2': '#afa', '3': '#acf', '4': '#faf', '5': '#aaa'};
    for (var i = 0; i < p.length; i++) {
        if (p[i] >= 'a' && p[i] <= 'z' ||
            p[i] >= 'A' && p[i] <= 'Z') {
            accumSyllable += p[i];
        } else if (p[i] >= '1' && p[i] <= '5') {
            ret += "<span style='color:" + colorMap[p[i]] + ";'>" +
                accumSyllable + p[i] + "</div>";
            accumSyllable = '';
        } else {
            ret += "<span style='color:" + colorMap['5'] + ";'>" +
                accumSyllable + p[i] + "</div>";
            accumSyllable = '';
        }
    }
    return ret;
}
function speakAns() {
    document.getElementById('info').innerHTML =
        zText + ' ' + colorPinyin(pyText) + ' ' + eText;
    speechSynthesis.cancel();
    espeak("For the Chinese:");
    zspeak(zText);
    espeak("The English is:");
    espeak(eText);
}
function newQ() {
    var nowSecs = Math.round(Date.now() / 1000);
    for (var curHSetI = 0; curHSetI < entries.length; curHSetI++) {
        [entryId, zText, pyText, eText] = entries[curHSetI];
        var curRecord = localStorage[subId + entryId];
        if (curRecord) {
            var nextSecs;
            [waitDaysIfCorrect, nextSecs] = JSON.parse(curRecord);
            if (nowSecs >= nextSecs) break;
        } else {
            waitDaysIfCorrect = 1;
            break;
        }
    }
    if (curHSetI == entries.length) {
        stage = awaitStart;
        document.form.button1.value = "Play";
        document.form.button2.value = "";
        document.form.button3.value = "";
        espeak("Congratulations, you are done for now.");
        return;
    }
    stage = awaitPlayAns;
    document.form.button1.value = "Repeat";
    document.form.button2.value = "Solution";
    document.form.button3.value = "Know it; Next";
    speakQ();
}
function answer(correct) {
    if (stage == awaitPlayAns && !correct) {
        stage = awaitAns;
        document.form.button2.value = "Wrong";
        document.form.button3.value = "Right";
        speakAns();
        return;
    }

    if (stage == awaitStart) return;
    document.getElementById('info').innerHTML = '';
    var nowSecs = Math.round(Date.now() / 1000);
    var nextSecs;
    if (correct) {
        nextSecs = nowSecs + (waitDaysIfCorrect - 1) * daySecs + workDaySecs;
        nextWaitDaysIfCorrect = 2 * waitDaysIfCorrect;
    } else {
        nextSecs = nowSecs + waitSecsIfWrong;
        nextWaitDaysIfCorrect = 1;
    }
    localStorage[subId + entryId] =
        JSON.stringify([nextWaitDaysIfCorrect, nextSecs]);
    newQ();
}
</script>
</head><body style="background:black;">
<div id="info" style="position: absolute; top: 10px; left: 10px; font-size: 400%; color: white;"></div>
<form name="form" onsubmit="return false">
<input type="button" name="button1" style="height:33%; width:100%; font-size:80px; background-color: transparent; color: white;" value="Play" onclick="play()">
<br>
<input type="button" name="button2" style="height:33%; width:100%; font-size:80px; background-color: transparent; color: white;" value="" onclick="answer(false)">
<br>
<input type="button" name="button3" style="height:33%; width:100%; font-size:80px; background-color: transparent; color: white;" value="" onclick="answer(true)">
</form>
</body></html>
